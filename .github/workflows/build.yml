name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:26.04

    steps:
      - uses: actions/checkout@v5

      - name: Install build tools
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            gcc-15 g++-15 \
            cmake \
            git \
            ca-certificates \
            python3

      - name: Generate data headers
        run: ./bin/generate_data_headers.sh

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15

      - name: Build
        run: cmake --build build -j

      - name: Run lft2 and capture output
        run: |
          ./build/backtest > output.txt
          cat output.txt

      - name: Run backtest and generate statistics JSON
        run: |
          ./build/backtest --json > stats.json
          echo "Generated statistics:"
          cat stats.json

      - name: Update HTML with output and charts
        run: |
          python3 << 'PYTHON'
          import html
          import json
          from datetime import datetime

          # Read program output
          with open('output.txt', 'r') as f:
              output = f.read()

          # Read backtest statistics
          with open('stats.json', 'r') as f:
              asset_stats = json.load(f)

          # Read HTML template
          with open('docs/index.html', 'r') as f:
              page = f.read()

          # Process JSON price files for charts only
          chart_data = {}
          stocks = ['aapl', 'amzn', 'asml', 'baba', 'bac', 'cat', 'cop', 'cost', 'crml', 'cvx',
                    'de', 'dia', 'ge', 'googl', 'gs', 'hon', 'ief', 'iwm', 'jnj', 'jpm',
                    'ko', 'lly', 'lmnd', 'meta', 'ms', 'msft', 'nvda', 'nvo', 'pep', 'pfe',
                    'pg', 'qqq', 'rsp', 'sap', 'slb', 'spy', 'tlt', 'tsla', 'tsm', 'unh',
                    'vnq', 'wmt', 'xlf', 'xlk', 'xom']

          from datetime import datetime as dt

          for stock in stocks:
              json_file = f'prices/{stock}.json'
              try:
                  with open(json_file, 'r') as f:
                      data = json.load(f)

                  # Handle both {"bars": [...]} and [...] formats
                  bars = data.get('bars', data) if isinstance(data, dict) else data

                  # Convert to lightweight-charts format for visualization only
                  valid_bars = []
                  for bar in bars:
                      # Skip bars with null values
                      if all(bar.get(k) is not None for k in ['t', 'o', 'h', 'l', 'c']):
                          # Convert ISO timestamp to Unix timestamp
                          timestamp = int(dt.fromisoformat(bar['t'].replace('Z', '+00:00')).timestamp())
                          valid_bars.append({
                              'time': timestamp,
                              'open': float(bar['o']),
                              'high': float(bar['h']),
                              'low': float(bar['l']),
                              'close': float(bar['c'])
                          })

                  chart_data[stock.upper()] = valid_bars
                  print(f"Processed {stock.upper()}: {len(valid_bars)} bars for charts")
              except Exception as e:
                  print(f"Error processing {stock}: {e}")
                  import traceback
                  traceback.print_exc()

          # Replace placeholders
          timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          escaped_output = html.escape(output)

          page = page.replace('TIMESTAMP_PLACEHOLDER', timestamp)
          page = page.replace('OUTPUT_PLACEHOLDER', escaped_output)
          page = page.replace('CHART_DATA_PLACEHOLDER', json.dumps(chart_data))
          page = page.replace('ASSET_STATS_PLACEHOLDER', json.dumps(asset_stats))

          # Write updated HTML
          with open('docs/index.html', 'w') as f:
              f.write(page)

          print(f"Updated HTML with timestamp: {timestamp}")
          print(f"Program output length: {len(output)} chars")
          print(f"Chart data for {len(chart_data)} stocks")
          print(f"Backtest statistics for {len(asset_stats)} stocks from C++ backtest")
          PYTHON

      - name: Copy stats.json to docs for serving
        run: |
          cp stats.json docs/stats.json
          echo "Copied stats.json to docs/"

      - name: Verify HTML output
        run: |
          echo "=== Checking for placeholders in HTML ==="
          grep -o "PLACEHOLDER" docs/index.html || echo "No placeholders found (good!)"
          echo "=== HTML file size ==="
          ls -lh docs/index.html
          ls -lh docs/stats.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
