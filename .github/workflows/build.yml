name: Build and Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:26.04

    steps:
      - uses: actions/checkout@v5

      - name: Install build tools
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            gcc-15 g++-15 \
            cmake \
            git \
            ca-certificates \
            python3

      - name: Generate data headers
        run: ./bin/generate_data_headers.sh

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15

      - name: Build
        run: cmake --build build -j

      - name: Run and capture output
        run: |
          ./build/lft2 > output.txt
          cat output.txt

      - name: Update HTML with output and charts
        run: |
          python3 << 'PYTHON'
          import html
          import json
          import glob
          from datetime import datetime

          # Read program output
          with open('output.txt', 'r') as f:
              output = f.read()

          # Read HTML template
          with open('docs/index.html', 'r') as f:
              page = f.read()

          # Process JSON price files for charts
          chart_data = {}
          stocks = ['aapl', 'amzn', 'asml', 'baba', 'bac', 'cat', 'cop', 'cost', 'crml', 'cvx']

          for stock in stocks:
              json_file = f'prices/{stock}.json'
              try:
                  with open(json_file, 'r') as f:
                      bars = json.load(f)

                  # Convert to lightweight-charts format
                  chart_data[stock.upper()] = [
                      {
                          'time': bar['t'],
                          'open': bar['o'],
                          'high': bar['h'],
                          'low': bar['l'],
                          'close': bar['c']
                      }
                      for bar in bars
                  ]
              except Exception as e:
                  print(f"Error processing {stock}: {e}")

          # Replace placeholders
          timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')
          escaped_output = html.escape(output)

          page = page.replace('TIMESTAMP_PLACEHOLDER', timestamp)
          page = page.replace('OUTPUT_PLACEHOLDER', escaped_output)
          page = page.replace('CHART_DATA_PLACEHOLDER', json.dumps(chart_data))

          # Write updated HTML
          with open('docs/index.html', 'w') as f:
              f.write(page)

          print(f"Updated HTML with timestamp: {timestamp}")
          print(f"Output length: {len(output)} chars")
          print(f"Chart data for {len(chart_data)} stocks")
          PYTHON

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
